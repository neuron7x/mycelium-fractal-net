name: PR Gate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  lint:
    name: PR Gate / lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: |
            requirements.txt
            pyproject.toml
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
      - name: Ruff lint/format
        run: |
          ruff check .
          ruff format --check .

  typecheck:
    name: PR Gate / typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: |
            requirements.txt
            pyproject.toml
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
      - name: Mypy
        run: mypy src/mycelium_fractal_net

  tests-fast:
    name: PR Gate / tests-fast
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: |
            requirements.txt
            pyproject.toml
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
      - name: Pytest (fast suite with coverage)
        id: pytest
        run: |
          mkdir -p artifacts
          set +e
          pytest -q -m "not slow and not integration" \
            --junitxml=artifacts/junit.xml \
            --cov=mycelium_fractal_net \
            --cov-report=xml:artifacts/coverage.xml
          status=$?
          set -e
          echo "${status}" > artifacts/pytest_exit_code.txt
          echo "exit_code=${status}" >> "$GITHUB_OUTPUT"
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-gate-test-artifacts
          path: artifacts
          if-no-files-found: error
      - name: Tests summary
        if: always()
        run: |
          echo "## PR Gate tests-fast" >> "$GITHUB_STEP_SUMMARY"
          echo "- Pytest exit code: ${{ steps.pytest.outputs.exit_code }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- JUnit: artifacts/junit.xml" >> "$GITHUB_STEP_SUMMARY"
          echo "- Coverage (cobertura): artifacts/coverage.xml" >> "$GITHUB_STEP_SUMMARY"
      - name: Fail if tests failed
        if: steps.pytest.outputs.exit_code != '0'
        run: exit 1

  security-min:
    name: PR Gate / security-min
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: "3.12"
          cache: pip
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-audit bandit
      - name: pip-audit
        run: pip-audit -r requirements.txt --strict --desc on
      - name: Bandit
        run: bandit -r src -ll
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --no-git -v
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
